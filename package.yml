name       : apparmor
version    : 3.0.4
release    : 14
source     :
    - https://gitlab.com/apparmor/apparmor/-/archive/v3.0.4/apparmor-v3.0.4.tar.gz : 85dd3aaaf6f5358db723c24c4f74fd2b2ffe99f76f3ac6d188c4e3b048a53346
license    :
    - GPL-2.0-only
    - LGPL-2.1-or-later
component  : security.library
summary    : AppArmor LSM user-space component
description: |
    AppArmor LSM user-space component
builddeps  :
    - pkgconfig(python3)
    - dejagnu      # Tests
    - perl-gettext # Tests
    - pyflakes     # Tests
    - swig
rundeps    :
    - python3
networking : yes
environment: |
    export PYTHON=/usr/bin/python3
    export PYTHON_VERSIONS=python3
setup      : |
    cd libraries/libapparmor
    %autogen --with-python
build      : |
    %make -C libraries/libapparmor
    %make -C binutils
    %make -C parser
    %make -C profiles
    %make -C utils
    %make -C changehat/pam_apparmor
install    : |
    # TODO: Validate profiles, tools, etc, and make stateless!
    %make_install -C libraries/libapparmor
    %make_install -C binutils
    %make_install -C parser
    %make_install -C profiles
    %make_install -C utils
    %make_install -C changehat/pam_apparmor
    %make_install -C parser install-systemd

    # Enable apparmor service by default
    install -dm00755 $installdir/%libdir%/systemd/system/multi-user.target.wants
    ln -sv %libdir%/systemd/system/apparmor.service $installdir/%libdir%/systemd/system/multi-user.target.wants/apparmor.service

    install -Dm 00644 $pkgfiles/apparmor.tmpfiles $installdir/usr/lib/tmpfiles.d/apparmor.conf

    # For now remove unvalidated profiles..
    rm -v $installdir/etc/apparmor.d/*.*.*

    # Disable apparmor for php-fpm systemd service
    rm -v $installdir/etc/apparmor.d/php-fpm
